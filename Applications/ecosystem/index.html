 <html style="background-color: #1D1D1D">
	<head>
		<meta charset="utf-8" />

		<!--[if IE]>
			<link rel="stylesheet" href="./ie9.css" type="text/css" />
    <![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes" />

		<script src="../assets/bootstrap-3.0.0/js/jquery.js"></script>
	    <link href="../assets/bootstrap-3.0.0/css/bootstrap.css" rel="stylesheet" type="text/css">
	    <link href="../assets/style.css?6" rel="stylesheet" type="text/css">
	    <script src="../assets/bootstrap-3.0.0/js/bootstrap.min.js"></script>
		<link rel="stylesheet" href="./style.css" type="text/css" />
		<link rel="stylesheet" href="assets/jquery.mCustomScrollbar.css" />
		<script src="assets/jquery.mCustomScrollbar.concat.min.js"></script>

		<script type="text/javascript">
			$(window).load(function() {
				$("#mcs_container").mCustomScrollbar({ alwaysShowScrollbar: 2 });

				$("#mcs_container2").mCustomScrollbar({ alwaysShowScrollbar: 2 });

			});


			var current_app = "";
			var url_arr = window.location.href.split("/");;
		    var url = url_arr[0] + '//' + url_arr[2] + '/';
			$(function() {
				$.ajax({
					url: url + 'bazaar?apps=',
					cache: false
				}).done(function( result ) {
					var buttons = $('#main_buttons');
					$(buttons).removeAttr('id');
					buttons = buttons.clone();
					if (first_button == null)
						first_button = buttons;
					$(buttons).children('a').html("Visual programming");
					$(buttons).children('a').attr('href', '#visualprogramming');
					$(buttons).children('a').removeClass('lock');
					$(buttons).appendTo('.list-group');
					$(buttons).show();
					current_app = 'visualprogramming';

					desc = $('.description');
					var first_button = null;
					$.each( result, function( key, value ) {
						buttons = buttons.clone();
						if (first_button == null)
							first_button = buttons;
						$(buttons).children('a').html(value.name);
						$(buttons).children('a').attr('href', '#' + key);
						$(buttons).children('a').removeClass('lock');
						if(value.type=='demo')
							$(buttons).children('a').addClass('lock');

						$(buttons).appendTo('.list-group');
						$(buttons).show();
						current_app = key;
					});

					$('a').unbind('click');
					$('a').unbind('touchend');
					$('a').on('click touchend', onLinkClicked);

					$('.buttons').click(function() {
						key = $(this).children('a').attr('href').substr(1);
						if (key == 'visualprogramming')
						{
							$('.description').children('.name').html("Visual programming");
							$('.description').children('.icon').attr('src', '/images/img_visualprog.png');
							$('.description').children('.icon').css('width', '480px');
							$('.description').children('.desc').html('<p>This is the perfect tool for newcomers to have fun while learning and putting their ideas into practice. It is equally suitable for developers that would like to prototype their ideas faster</p> \
								<p>Features:</p> \
								<ul> \
								<li>Program Red Pitaya via intuitive WEB based service using blocks or other programming languages (python, C/C++, Java Script,..)</li> \
								<li>Create your own dashboards with real time graphs, dials, meters, sliders and buttons</li> \
								<li>Connect sensors and measure temperature, moisture, alcohol, water level, vibrations, UV light, sound, pressure, air quality or detect motion and more</li> \
								<li>Connect actuators and indicators such as LEDs, displays, motors or relays in order to control high load devices</li> \
								<li>Share measurements or send notifications to email or even social networks like Facebook and Twitter</li> \
								</ul> \
							');
							$('#run').html('Run');
							$("#run").attr('href3', 'http://account.redpitaya.com/try-visual-programming.php');
							$("#run").css('visibility', 'visible');
							$("#demo").css('visibility', 'hidden');
							$("#run").removeAttr('href');
						} else {
							$('.description').children('.name').html(result[key].name);
							$('.description').children('.icon').attr('src', url + key + '/info/icon.png');
							$('.description').children('.icon').css('width', '');
							$('.description').children('.desc').html(result[key].description);
							if (result[key].type == "demo")
							{
									$("#run").removeAttr('href');
									$("#run").attr('href2', url + 'instruct.html#'+key);
									$('#run').html('Run');
									$("#run").css('visibility', 'visible');
									$("#demo").css('visibility', 'visible');
							}
							else if (result[key].type == "run")
							{
								$("#run").attr('href', url + key + '/?type=run');
								$('#run').html('Run');
								$("#run").css('visibility', 'visible');
								$("#demo").css('visibility', 'visible');
							}
							else if (result[key].type == "old_app")
							{
								$('#run').html('Run');
								$("#run").attr('href', url + key);
								$("#run").css('visibility', 'visible');
								$("#demo").css('visibility', 'hidden');
							}

							$("#demo").attr('href', url + key + '/?type=demo');

							$(desc).show();
						}
					});

					first_button.click();

					//$(selector).mCustomScrollbar({ option: value });
					$("#mcs_container .buttons a").on('click', function(){
						$("#mcs_container .buttons a").removeClass('item-active');
						$("#mcs_container .buttons a").removeClass('item-active-lock');
						if($(this).hasClass('lock'))
							$(this).addClass('item-active-lock');
						else
							$(this).addClass('item-active');
					});


				}).fail(function( msg ) {
					alert("Something has gone wrong. Is there a problem with the server?");
			  }	)
			});

			$(function() {
				document.getElementsByTagName("title")[0].innerHTML = ("My Red Pitaya ("+window.location.hostname+")");

				var xmlHttp = new XMLHttpRequest();
				xmlHttp.open("GET", 'info/info.json', false);
				xmlHttp.send(null);
				var info = JSON.parse(xmlHttp.responseText);
				$('#ver').html(info['description'].substring(0, info['description'].length - 1) + ' ' + info['version']);
			});

		</script>
		<title>My Red Pitaya</title>
	</head>

<body style="background-color: #1D1D1D;">
<div class="pagewrapper">
	<div class="panel panel-default" style="background-color: #1D1D1D; margin: 50px auto;">
		<div class="panel-body">
			<div class="divider"></div>
			<div class="row" style="padding: 20px;">
				<div class="col-xs-2" style="min-width: 270px; height: 400;">
					<div id="mcs_container">
							<img class="appicon" style="width: 150px; margin: 0;" src="../assets/images/logo_white.png">
							<h4 style="color: silver;">Select the Instrument:</h4>
							<div class="list-group pull-left">
								<div class="buttons" id="main_buttons" style="width: 205px; display: none; margin: 20px auto; border-radius: 0px;">
									<a href="#" id="buttons" style="border-radius: 0;" class="list-group-item">1</a>
								</div>
							</div>
						</div>
						<div class="bazaar-link" style="margin-top: 20px; margin-left: -40px">
							<a href="bazaar" class="list-group-item more">Get more applications</a>
						</div>
					</div>

				<div class="col-xm-9" id="right-col" style="mix-width: 500px; height: 400;color: silver;">
					<div id="mcs_container2">
					<div class="description" style="display: none;">
						<h2 class="name"></h2>
						<img class="icon" src="">
						<p class="desc"></p>
					</div>
				</div>
				</div>
			</div>
			<div class="container">
				<div class="bazaar-link" style="float:right; visibility: hidden;">
					<a href="#run" id="run" class="list-group-item btn" style="margin: 0 60 0 0;">Run</a>
				</div>
				<div class="bazaar-link" style="float:right; visibility: hidden;" >
					<a href="#demo" id="demo" class="list-group-item btn">Demo</a>
				</div>
			</div>
		</div>
	</div>

  <!-- Modal -->
	<div class="modal fade" id="no_internet" role="dialog">
		<div class="modal-dialog">

			<!-- Modal content-->
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal">&times;</button>
					<h4 class="modal-title">Your Red Pitaya has no connection to the Internet!</h4>
				</div>
				<div class="modal-body">
					<p>Without internet connection it is not possible to:</p>
					<ul>
						<li>unlock PRO applications</li>
						<li>install applications from open source marketplace</li>
						<li>run visual programming</li>
					</ul>
					<p>Please follow <a href="http://redpitaya.com/quick-start/">http://redpitaya.com/quick-start/</a> instructions to find out how to connect your Red Pitaya to the internet.</p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
				</div>
			</div>

		</div>
	</div>
	<div id="ver" style="color:#C0C0C0; margin-top: -45px;"></div>
</div>
<script>
if (typeof String.prototype.startsWith != 'function') {
	String.prototype.startsWith = function (str){
		return this.indexOf(str) === 0;
	};
}

var connectionFlag = -1;
function checkNetConnectionImpl(success, fail) {
/*	var xhr = new XMLHttpRequest();
	xhr.timeout = 2000;
	var file = "check_jq";
	var r = Math.round(Math.random() * 10000);
	xhr.open('HEAD', file + "?subins=" + r, false);
	try {
		xhr.send();
		if (xhr.status >= 200 && xhr.status < 304) {
			return true;
		} else {
			return false;
		}
	} catch (e) {
		return false;
	}
	*/
	$.ajax({ method: "GET",  url: "check_jq",  timeout: 2000})
	.done(function() { 
		success(); 
	})
	.fail(function() { 
		fail(); 
	});
}
/*
function checkNetConnection(){
	connectionFlag= -1;
	checkNetConnectionImpl();
	while(connectionFlag == -1);
	return connectionFlag == 1;
}
*/
var element  = window;

var onLinkClicked = function()
{
	if ($(this).attr('id') == 'run')
	{
		href3 = $(this).attr('href3');
		if(href3!=undefined && href3!="")
		{
			var success = function() {
				window.location = href3;
			}
			var fail = function()
			{
				$('#no_internet').modal('show');
			}	
			checkNetConnectionImpl(success, fail);
		} else
		{
			element = $(this)
			var fail = function() {
				$('#no_internet').modal('show');
			}	
			checkNetConnectionImpl(verifyLic, fail);
		}
	}else
	{
	    var el = $(this);
	    var link = el.attr('href') != undefined ? el.attr('href') : el.attr('href2');
		console.log('clicked ', link);
	    window.location = link;
	}
}

var verifyLic = function(element){

	if (element.attr('href') == undefined)
	{
		var post_uri = 'http://store.redpitaya.com/upload_id_file/';
		var req_uri = 'http://store.redpitaya.com/get_lic/?rp_mac=';

		$.ajax({
			method: "GET",
			url: "lic.lic"
		})
		.done(function( msg ) {
			window.location = $('#run').attr('href2');
		})
		.fail(function( msg ) {
			$.ajax({
				method: "GET",
				url: "idfile.id"
			})
			.done(function( msg ) {
				var obj = jQuery.parseJSON( msg );
				if (obj != undefined && obj != null && obj.mac_address != undefined  && obj.mac_address != null)
					req_uri = req_uri + obj.mac_address;
				$.ajax({
					method: "POST",
					url: post_uri,
					data: 'id_file=' + encodeURIComponent(msg)
				})
				.done(function( msg ) {
					if (msg == "OK"){
						$.ajax({
							method: "GET",
							url: req_uri
						})
						.done(function( msg ) {
							var res_msg = msg + "\r\n";
							console.log(res_msg);
							$.ajax({
								method: "POST",
								dataType: 'json',
								data: { 'lic.lic' : res_msg },
								contentType: 'application/json; charset=utf-8',
								url: "/lic_upload",
							})
							.done(function( msg ) {
							})
							.fail(function( msg ) {
								if (msg.responseText.startsWith("OK"))
									window.location = "index.html";
								else
									window.location = $('#run').attr('href2');
							});
						})
						.fail(function( msg ) {
							window.location = $('#run').attr('href2');
						});
					} else
					{
						window.location = $('#run').attr('href2');
					}
				})
				.fail(function( msg ) {
					window.location = $('#run').attr('href2');
				});
			})
			.fail(function( msg ) {
				window.location = $('#run').attr('href2');
			});
		})
	} else {
		window.location = element.attr('href');
	}
}

$('a').unbind('click');
$('a').unbind('touchend');
$('a').on('click touchend', onLinkClicked);
</script>
</body>
</html>
